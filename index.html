<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Met Ultah Sayang</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(to bottom, #ffe6f0 0%, #e6f7ff 100%);
      overflow: hidden;
    }

    h1 {
      margin: 10px 0;
      color: #e91e63;
      z-index: 10;
      position: relative;
    }

    .instruction {
      margin: 0 0 20px 0;
      color: #555;
      z-index: 10;
      position: relative;
    }

    /* canvas urutan layer */
    #balloons {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    #canvas {
      position: relative;
      z-index: 1;
      border: 1px solid transparent; /* ubah ke red untuk debug */
      background: transparent;
    }

    #confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    /* popup */
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      box-sizing: border-box;
      animation: fadeIn 0.5s ease-out;
      z-index: 3;
    }

    .popup-content {
      background: rgba(255,255,255,0.85);
      padding: 20px 30px;
      font-size: clamp(18px, 2vw, 24px);
      font-weight: bold;
      border-radius: 12px;
      color: #333;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      animation: scaleUp 0.5s ease-out;
    }

    .hidden {
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleUp {
      from { transform: scale(0.7); }
      to { transform: scale(1); }
    }
  </style>
</head>
<body>
  <h1>Make a wish ‚ù§Ô∏è</h1>
  <p class="instruction">Tiup lilinnya lewat mic ya üòòüéÇ </p>

  <canvas id="balloons"></canvas>
  <canvas id="canvas" width="500" height="450"></canvas>
  <canvas id="confetti"></canvas>

  <div id="popup" class="popup hidden">
    <div class="popup-content">
      üéâ Selamat Ulang Tahun Sayang üéâ<br>
      ~nisa
    </div>
  </div>
  
  <audio id="cheerSound" src="https://www.myinstants.com/media/sounds/kids-cheering.mp3"></audio>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const confettiCanvas = document.getElementById("confetti");
    const confettiCtx = confettiCanvas.getContext("2d");
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;

    const balloonsCanvas = document.getElementById("balloons");
    const balloonsCtx = balloonsCanvas.getContext("2d");
    balloonsCanvas.width = window.innerWidth;
    balloonsCanvas.height = window.innerHeight;

    let candlesLit = [true, true, true, true, true];
    let confettiPieces = [];
    let balloons = [];

    // ====== CAKE ======
    function drawCake() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // tinggi layer
      const bottomHeight = 60;
      const middleHeight = 50;
      const topHeight = 50;

      // lebar layer
      const bottomWidth = 260;
      const middleWidth = 220;
      const topWidth = 200;

      // posisi X layer
      const bottomX = (canvas.width - bottomWidth) / 2;
      const middleX = (canvas.width - middleWidth) / 2;
      const topX = (canvas.width - topWidth) / 2;

      // posisi Y layer
      const bottomY = 300;
      const middleY = bottomY - middleHeight;
      const topY = middleY - topHeight;

      // layer bawah
      ctx.fillStyle = "#f4a7b9";
      ctx.fillRect(bottomX, bottomY, bottomWidth, bottomHeight);

      // layer tengah
      ctx.fillStyle = "#c8e6f8";
      ctx.fillRect(middleX, middleY, middleWidth, middleHeight);

      // layer atas
      ctx.fillStyle = "#d9f8c8";
      ctx.fillRect(topX, topY, topWidth, topHeight);

      // lilin
      const candleCount = candlesLit.length;
      const spacing = topWidth / (candleCount + 1);

      for (let i = 0; i < candleCount; i++) {
        const x = topX + spacing * (i + 1);
        const y = topY - 30; 

        // batang lilin
        ctx.fillStyle = "#87cefa";
        ctx.fillRect(x - 5, y, 10, 40);

        if (candlesLit[i]) {
          const flickerX = (Math.random() - 0.5) * 4;
          const flickerY = (Math.random() - 0.5) * 2;
          const flameHeight = 12 + Math.random() * 2;

          ctx.beginPath();
          ctx.ellipse(
            x + flickerX,
            y - 10 + flickerY,
            6,
            flameHeight,
            0,
            0,
            Math.PI * 2
          );
          ctx.fillStyle = "orange";
          ctx.fill();

          ctx.shadowColor = "yellow";
          ctx.shadowBlur = 15;
          ctx.fill();
          ctx.shadowBlur = 0;
        }
      }
    }

    function animate() {
      drawCake();
      requestAnimationFrame(animate);
    }
    animate();

    // ====== CONFETTI ======
    function ConfettiPiece(x, y, color) {
      this.x = x;
      this.y = y;
      this.color = color;
      this.size = Math.random() * 6 + 4;
      this.speedY = Math.random() * 3 + 2;
      this.speedX = (Math.random() - 0.5) * 2;
    }

    function launchConfetti() {
      for (let i = 0; i < 150; i++) {
        let x = Math.random() * confettiCanvas.width;
        let y = -10;
        let colors = ["#ff7675", "#74b9ff", "#ffeaa7", "#55efc4", "#fd79a8"];
        let color = colors[Math.floor(Math.random() * colors.length)];
        confettiPieces.push(new ConfettiPiece(x, y, color));
      }
    }

    function drawConfetti() {
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      for (let i = 0; i < confettiPieces.length; i++) {
        let p = confettiPieces[i];
        confettiCtx.fillStyle = p.color;
        confettiCtx.beginPath();
        confettiCtx.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
        confettiCtx.fill();
        p.y += p.speedY;
        p.x += p.speedX;

        if (p.y > confettiCanvas.height) {
          confettiPieces.splice(i, 1);
          i--;
        }
      }
      requestAnimationFrame(drawConfetti);
    }
    drawConfetti();

    // ====== BALLOONS ======
    function Balloon(x, y, color) {
      this.x = x;
      this.y = y;
      this.color = color;
      this.size = Math.random() * 30 + 20;
      this.speedY = Math.random() * 1 + 0.5;
      this.swing = Math.random() * 0.05 + 0.02;
      this.angle = Math.random() * Math.PI * 2;
    }

    function launchBalloons() {
      for (let i = 0; i < 15; i++) {
        let x = Math.random() * balloonsCanvas.width;
        let y = balloonsCanvas.height + 50;
        let colors = ["#ff7675", "#74b9ff", "#55efc4", "#ffeaa7", "#fd79a8"];
        let color = colors[Math.floor(Math.random() * colors.length)];
        balloons.push(new Balloon(x, y, color));
      }
    }

    function drawBalloons() {
      balloonsCtx.clearRect(0, 0, balloonsCanvas.width, balloonsCanvas.height);
      for (let i = 0; i < balloons.length; i++) {
        let b = balloons[i];
        balloonsCtx.beginPath();
        balloonsCtx.ellipse(b.x, b.y, b.size * 0.6, b.size, 0, 0, Math.PI * 2);
        balloonsCtx.fillStyle = b.color;
        balloonsCtx.fill();

        // tali balon
        balloonsCtx.beginPath();
        balloonsCtx.moveTo(b.x, b.y + b.size);
        balloonsCtx.lineTo(b.x, b.y + b.size + 40);
        balloonsCtx.strokeStyle = "#555";
        balloonsCtx.stroke();

        // gerakan
        b.y -= b.speedY;
        b.angle += b.swing;
        b.x += Math.sin(b.angle) * 0.5;

        if (b.y + b.size < 0) {
          balloons.splice(i, 1);
          i--;
        }
      }
      requestAnimationFrame(drawBalloons);
    }
    drawBalloons();

    // ====== MIC BLOW ======
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const mic = audioContext.createMediaStreamSource(stream);
        mic.connect(analyser);
        const data = new Uint8Array(analyser.frequencyBinCount);

        function detectBlow() {
          analyser.getByteFrequencyData(data);
          let values = 0;
          for (let i = 0; i < data.length; i++) values += data[i];
          let average = values / data.length;

          if (average > 30 && candlesLit.some(l => l)) {
            for (let i = 0; i < candlesLit.length; i++) {
              if (candlesLit[i]) {
                candlesLit[i] = false;
                break;
              }
            }
            drawCake();

            if (!candlesLit.some(l => l)) {
              launchConfetti();
              launchBalloons();
              document.getElementById("popup").classList.remove("hidden");

              const cheer = document.getElementById("cheerSound");
              cheer.play().catch(() => {});
            }
          }
          requestAnimationFrame(detectBlow);
        }
        detectBlow();
      })
      .catch(err => console.log("Mic not allowed", err));

    // fallback klik
    canvas.addEventListener("click", () => {
      if (candlesLit.some(l => l)) {
        for (let i = 0; i < candlesLit.length; i++) {
          if (candlesLit[i]) {
            candlesLit[i] = false;
            break;
          }
        }
        drawCake();

        if (!candlesLit.some(l => l)) {
          launchConfetti();
          launchBalloons();
          document.getElementById("popup").classList.remove("hidden");

          const cheer = document.getElementById("cheerSound");
          cheer.play().catch(() => {});
        }
      }
    });
  </script>
</body>
</html>
